1. redis和mysql现在是用ip连接，改成域名

2. C++实现域名解析为IP

3. 框架和业务服MySQL用IP和端口配置，数据库迁移时要修改大量的配置文件,用域名替换

4. 框架和数据库和业务服务部署在不同的机器A,B,C上，避免负载过大导致响应慢。开发机上面，数据库单独一台机器，业务+框架另外一台机器

5. 磁盘空间不足，需要重新挂载一块数据盘，如何挂载?开发机数据和软件安装包应该放在不同磁盘上面,如何监控磁盘使用的空间?

6. 内网开发机数据库更新，比如增加/删除数据，表结构修改，增加库，如何增量修改到外网？

7. 内网更新如何增加替换到外网

   ```shell
   1. 搭建svn服务器
   2. 每次更新提交到svn上面，记录版本号
   3. 把svn的内容发布到外网
   ```

8. centos系统无法关闭

   ```shell
   某些软件阻止系统关闭，必须这些软件停止
   ```

9. 服务的日志查看困难

   ```shell
   服务的对外接口或者RPC内部接口，必须打印输入参数,否则日志难以查看!!
   ```

10. 业务代码混乱，如何解决[多种业务混在一起]

    ```shell
    1. 一个函数里有多个业务，每个业务代码分开，不要有耦合关系
    2. 每一个步骤分解为一个函数
    ```

    

11. 测试用的机器和开发的必须分开，否则会出现测试通过的bug反反复复

12. tars的服务，监听的地址，写死了网卡的ip，因为127.0.0.1：8080 与192.168.0.1:8080 用途不一致，导致部署新机器需要修改大量配置文件

13. 配置文件用excel，无法与历史文件对比，可以用json或者xml替换

14. 策划用excel制作配置，然后导出为xml或者json，然后提交到svn上面，最后再通过管理后台发布新的配置文件到数据库里面

15. ios支付校验，内网的curl需要使用代理，外网不需要，如何解决

    ```shell
    # 1 
    用环境变量标识是否使用代理
    # 2 
    使用配置文件,不过每次发布都需要修改配置-->不推荐
    # 3
    从数据库读取配置,只需第一次发布外网的时候写入值
    ```

16. python脚本在centos上测试麻烦，只能打印日志定位错误

    ```
    可以在windows上测试，通过后再放到linux上面运行,比如仅仅涉及到文件操作的脚本
    ```

17. 发布外网测试注意事项

    ```shell
    # 1
    
    1.1:把数据库(redis和MySQL)清空,因为里面保存用户状态,旧状态经常无法与新代码兼容
    1.2:存放配置的数据库与内网一致,其它数据库和表清空
    
    # 2
    重启全部服务
    
    # 3
    绝对不可以无脑直接把内网数据库导入外网中
    ```

18. 如何方便查看外网的日志??

19. 数据库里硬编码机器IP，导致迁移要修改大量表记录！

    ```
    用域名替换IP
    ```

20. 内网和外网的MySQL，redis账号密码不一致,并且多个服务直连数据库,每次发布需要修改多个配置文件

    ```shell
    # 解决方案一
    数据库账号和密码从环境变量读取
    
    # 解决方案二
    有个文件保存数据库账号密码,所有服务从该文件读取账号密码
    
    # 辅助措施
    所有访问MySQL都通过代理,这样即使修改配置文件,也只改一个
    ```

21. 发布外网理想方案

    ```
    直接copy内网文件,不需要修改任何配置
    ```

22. 服务切分太细，导致发布，部署麻烦，修改需求时同时更改多个服务代码

    ```
    可以合并一些无状态服务[邮件,抽奖,商城之类]，一些堵塞的操作，比如http请求单独用一个服务来处理
    ```

23. 业务代码混乱

    ```shell
    一个函数里实现两个业务，
    
    
    业务A代码--步骤1
    业务B代码--步骤1
    ...
    业务A代码--步骤2
    业务B代码--步骤2
    
    # 如此混合起来会非常乱,可以组织为
    业务A代码--步骤1
    业务A代码--步骤2
    ...
    业务B代码--步骤1
    业务B代码--步骤2
    ```

24. 通过web后台修改游戏配置，需要手动操作tars_web重启服务，操作繁琐

    ```shell
    # 方式一[推荐的方式]
    web后台修改配置后，可以自动发指令重启依赖服务
    
    # 方式二[此方法复杂度更高]
    服务可以不重启更新配置,web后台发指令通知对应服务更新配置
    ```

25. tars框架没有提供`setTimeout`和`setInterval`类似接口

26. tars没有提供http访问接口，用curl会阻塞

    ```shell
    单独起一个服务,封装curl用来发起http访问,其他服务异步Rpc请求
    ```

27. web后台修改用户金币钻石，输入无限制，导致溢出

    ```shell
    在web后台文本框里限制只能是正数，且小于64位最大值
    ```

28. 客户端uid查询用户时，限制只能输入数字并且限制位数！

29. 配置文件里面的价格配置为小数，导致统计流水丢失精度

    ```shell
    price:19.99 配置在数据库里,读出来再std::stod 转换为小数会丢失精度
    
    # 解决方案一
    配置全部用整数
    
    # 解决方案二
    以字符串读出数据,原样写入统计日志,不进行转换
    ```

30. 全部配置统一用config服务读取，然后其它服务RPC从config读取配置

    > 问题： 更改配置需要重启几个服务
    >
    > 期望：可以从管理后台更新某个服务配置[类似Excel的操作]，更新完配置后直接重启
    >
    > 解决方案：
    >
    > 1. 配置文件用XML文件表示[XML可以git对比差异,策划将Excel导出为XML]
    > 2. web发起post请求更新配置后，后台自动重启服务，并提示成功/失败
    > 3. 每个服务的配置文件放自己的目录下面

31. 过早优化，连功能都没正确实现，采用一些非常复杂的解决方案，最后hold不住！

32. 很多if...else的分支，如何去掉，最好用单分支的

33. C++项目编译速度慢

    > 问题：大量小文件(*.cpp)，导致编译一次要很久
    >
    > 解决方案：减少编译单元个数(*.cpp)

34. 外网校验订单curl直连，内网curl通过http代理

    > 问题：每次发布外网，都要修改宏定义，重编
    >
    > 解决方案：利用条件变量来区分内网(开发环境)和外网(正式环境)
    >
    > ```cpp
    > string getAppVersion(){
    > 	char *pathvar = nullptr;
    > 
    > 	pathvar = getenv("APP_VERSION");
    > 	if (pathvar == nullptr){
    > 		return string("");
    > 	}else{
    > 		return string(pathvar);
    > 	}
    > }
    > 
    > int main()
    > {
    > 	string version = getAppVersion();
    > 	if (version == "release"){
    > 		//...
    > 	}else{
    > 		//...
    > 	}
    > 	return 0;
    > }
    > ```
    >
    
35. C++的map::at 或者vector::at抛出异常后，异常信息不显示具体在哪一行

    > 解决思路：**增加一层间接**,用函数包装map::at,函数调用时利用宏传入文件名和代码所在行数
    >
    > 额外：增加一层间接几乎可以解决所有问题
    >
    > 示例代码：
    >
    > ```cpp
    > template<typename T1, typename T2>
    > T2& getElement(T1& data, size_t index, const string& file, const string& funcName,size_t line)
    > {
    > 	try
    > 	{
    > 		return data.at(index);
    > 	}
    > 	catch (const std::exception& e)
    > 	{
    > 		cout << "out of range : [" << file << "::" << funcName << ":"  << line  << "] index : " <<  index << endl;
    > 		throw;
    > 	}
    > }
    > 
    > int main()
    > {
    > 	vector<int> v = { 1, 2, 3 };
    > 
    > 	try
    > 	{
    > 		int e = getElement<vector<int>, int>(v, 3, __FILE__, __FUNCTION__,__LINE__);
    > 	}
    > 	catch (const std::exception&e )
    > 	{
    > 		cout << "msg : " << e.what() << endl;
    > 	}
    > 	return 0;
    > }
    > ```

36. 每次发布外网，服务器的数据(redis，MySQL等)已清空，但是客户端未清空，会导致bug

    > 问题：订单校验时查找不到
    >
    > 原因：客户端保存有未校验的订单，但是服务器数据库已清空
    >
    > 解决方案：每次更新时客户端也要清空数据
    
37. 单步调试时，代码跳转错误

    > 原因：
    >
    > 1. gcc编译开启了优化
    > 2. 用了宏定义
    >
    > 解决方案：
    >
    > 1. gcc开启-g，并且优化等级为0
    > 2. 宏定义只替换一行
    
38. 统计数据入库有延迟，部署麻烦

    > 描述：用collect.py脚本收集日志，再用logToDB脚本入库
    >
    > 存在问题：每个节点都要部署一套脚本，并且入库有延时
    >
    > 改进的解决方案：实时入库
    >
    > ```shell
    > # 用tars框架新启动一个服务，提供RPC接口来将统计数据实时入库
    > ```

