# 第一章  部署架构

```ini
;架构一
[负载均衡]
desc = 使用DNS负载均衡

[反向代理]
desc = 外层部署多台nginx反向代理(TCP4层或者ws反向代理等),方便日后带宽扩容

[上游服务]
desc = 全部的上游服务在反向代理后,没有公网IP(没有公网IP会更加安全),和nginx在一个局域网内


;架构二
[单节点部署全部服务]
method-1 = nginx部署在宿主机,上游服务和DB 部署在docker里面,绑定宿主机的127.0.0.1的网卡的端口 [推荐]

method-2 = nginx部署在宿主机,上游服务和DB 部署在宿主机里,但是绑定127.0.0.1的网卡的端口,防火墙只需要对外暴露反向代理的端口
```



# 第二章  常见工作



## 2.1 创建非登录用户

```ini
 [创建]
 cmd = sudo useradd -s /sbin/nologin li
 
 [切换到非登录用户]
 cmd =  sudo su -s /bin/bash li
```



## 2.2 用非登录用户运行服务





## 2.3 内核参数配置

1. 调整进程最大打开文件数

   ```ini
   [查看]
   cmd = ulimit -a
   
   [调整]
   vi /etc/security/limits.conf
   * hard nofile 65536
   * soft nofile 65536
   
   重启机器
   ```
   
   



## 2.4 反向代理配置





## 2.5 静态资源服务器配置



## 2.6 php-fpm配置





## 2.7 Mysql配置

1. 主从配置
2. 参数优化
3. 监控

## 2.8 Mongodb配置

1. 主从配置
2. 监控



## 2.9 防火墙配置

1. 使用firewalld来配置



## 2.10 监控配置





## 2.11 上传包到服务器

1. 使用S3 Browser将文件上传到S3，并将ACL设置为All Users 可读
2. 在服务器上用wget下载包



## 2.12 下载包本地

1. 用aws的s3客户端将包上传到s3
2. 从s3下载包到本地



## 2.13 机器的时区和数据库时区

1. 修改机器时区

   ```ini
   [查看时间]
   cmd = date -R
   
   [查看全部可用时区]
   cmd =  timedatectl list-timezones
   
   [设置时区]
   cmd = timedatectl set-timezone "Asia/ShangHai"
   ```

2. MySQL时区

   ```ini
   show variables like "%time_zone%";
   +------------------+--------+
   | Variable_name    | Value  |
   +------------------+--------+
   | system_time_zone | -03    |
   | time_zone        | SYSTEM |
   +------------------+--------+
   
   ;MySQL默认使用系统时区
   ```
   

## 2.14 备份文件

```shell
mv ebin ebin-`date  +%Y-%m-%d-%H-%M-%S`
```



## 2.15 发布脚本示例

```shell
pm2 show schedule;
if [ $? = 0 ];then
	pm2 stop schedule && pm2 delete schedule;
fi
mv schedule schedule-`date  +%Y-%m-%d-%H-%M-%S` && \
unzip schedule.zip && \
cd schedule && \
npm install && \
tsc && \
pm2 start schedule.config.js --env production && \
cd ..
```

执行命令 source publish.sh 即可完成发布



## 2.16 域名配置



购买地址 = https://www.godaddy.com/



配置DNS记录

```ini
[A记录]
desc = 指向IP地址,
how  = godaddy配置的时候，姓名字段为@,数据字段就是ip地址,TTL600s

[CNAME记录]
;比如我们买的域名是shaoqing.org, 配置 CNAME 的name 为 www, value 为shaoqing.org
;那么 http://www.shaoqing.org 和 http://shaoqing.org 就是访问一样的页面了
;用这个方法可以把 shop.shaoqing.org 和 mail.shaoqing.org 指向不同的地方


;指向aws
;配置name 为 asset, value 为 asset.icashflow.cc.s3-website-sa-east-1.amazonaws.com
;那么 http://asset.icashflow.cc 就会指向aws的s3了, 注意s3的桶的名称必须和域名一样,即名称为
;asset.icashflow.cc,并且在属性里面开启托管静态资源网站
;最后的地址是http协议的,比如 http://asset.icashflow.cc.s3-website-sa-east-1.amazonaws.com 或者 http://asset.icashflow.cc
desc = 执行域名

[NS记录]
desc = 表示域名服务器记录，用来指定该域名由哪个DNS服务器来进行解析

[SOA记录]
desc = 是起始授权机构记录，说明了在众多 NS 记录里哪一台才是主要的服务器。在任何DNS记录文件中，都是以SOA ( Startof Authority )记录开始。SOA资源记录表明此DNS名称服务器是该DNS域中数据信息的最佳来源

;使用心得
;1 -- 正常游戏开发只需要配置一个A记录,CNAME记录不需要
;2 -- A记录如果存在多个,会解析为多个IP地址,每次请求时可能返回不同的地址,可以用来做负载均衡
;3 -- 遇到的问题：A记录配置两条,有一条IP是别人的,导致50%的概率链接不上服务器;每次ping的地址都不一样

;win刷新DNS记录
;使用管理员打开 cmd, 执行命令ipconfig /flushdns

```







# 第三章 S3

文档地址：https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html

## 3.1 安装

```shell
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```



## 3.2 配置

```shell
/usr/local/bin/aws configure

#配置项
AWS Access Key ID: AKIAVSFZTWBNFB7EFODG
AWS Secret Access Key: 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
Default region name : sa-east-1
Default output format [None]: json
```



## 3.3 列出桶

```shell
/usr/local/bin/aws s3 ls
```



## 3.4 列出桶里的文件

```shell
/usr/local/bin/aws s3 ls s3://apollo-plan
```



## 3.4 复制文件

类似scp

1. 将s3的文件复制到本地

   ```shell
   /usr/local/bin/aws s3 cp s3://apollo-plan/hk.pem .
   ```

2. 本地文件上传到s3

   ```shell
   /usr/local/bin/aws s3 cp ./code.tar.gz s3://apollo-plan/
   ```

3. 将本地文件上传到s3并且公开地址可以http下载

   ```shell
   /usr/local/bin/aws s3 cp ./code.tar.gz s3://apollo-plan/ --acl public-read
   ```



## 3.5 删除s3中的文件

```shell
aws s3 rm s3://bucket-name/example/filename.txt
```



## 3.6 配置s3为静态http网站

URL = https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteAccessPermissionsReqd.html



注意：

1. 不需要开启ACL
2. 可以把自己的域名映射过去





# 第四章 aws的服务器价格



配置

```ini
内存 = 16G
CPU = 8核心

[硬盘]
;硬盘类型就选择GP2 或者 GP3即可,不要选择其它的
;之前选 预配置IOPS SSD(IO1) 非常贵,一个月几万
类型 = GP3
大小 = 500G
IOPS = 10000
;默认
吞吐量 =125

[价格]
IOPS/天 = 1.94美元
GP3/天  = 2.21美元
;因此想要降低费用,就把内存和CPU降低,因为这边是收费的大部分
EC2/天  = 10.48美元,EC2的价格按小时计费,可以在账单或者购买机器的时候看到

;算下来一个月费用为439美元,折合人民币3000左右
;开发阶段可以买一个4核心8G内存的,节约成本

[推荐配置]
反向代理 = 2核心4G
业务    = 4核心8G 或者 4核心16G
```

