# 阿里云登录报警

***

1. 创建文件`/etc/ssh/sshrc`

   ```shell
   #!/bin/bash
   #获取登录者的用户名
   user=$USER
   #获取登录者的IP地址
   ip=${SSH_CLIENT%% *}
   #获取登录的时间
   time=$(date +%F%t%k:%M)
   #服务器的IP地址
   hostname=$(hostname)
   echo "content=$time,$user,$ip,$hostname" > log
   
   python /etc/ssh/testEmail.py   "$time" "$user" "$ip" "$hostname"
   ```

2. python脚本`testEmail.py`

   ```python
   #!/usr/bin/python
   # -*- coding: UTF-8 -*-
   
   import smtplib
   from email import encoders
   from email.header import Header
   from email.mime.text import MIMEText
   from email.utils import parseaddr, formataddr
   import sys
   
   
   def send_mail(dtime,duser,dip,dhostname):
       #基础信息
       # from_addr = input("From:")
       from_addr = "wzc_0618@126.com"
       password = "YOIWDIEQRANPYZSY"  # 这里是授权码
       #to_addr = from_addr
       to_addr = "wzc_0618@126.com"
       # password = raw_input("Password:")
       # to_addr = input("To:")
   
       def _format_addr(s):
               name, addr = parseaddr(s)
               return formataddr((Header(name, 'utf-8').encode(), addr))
   
       smtp_server = "smtp.126.com"
       mimetex = '您的机器:',dhostname,'，于:',dtime,'，被IP:',dip,'以账号',duser,'进行登录,请确认是否为公司员工。'
       #构造邮件
       msg = MIMEText(''.join(mimetex), 'plain', 'utf-8')
       msg['From'] = _format_addr("阿里云47.112.251.164")
       msg['To'] = _format_addr("wzc_0618@126.com")
       msg['Subject'] = Header("阿里云登录报警", 'utf-8').encode()
       #发送邮件
       server = smtplib.SMTP_SSL(smtp_server, 465)
       server.set_debuglevel(1)
       server.login(from_addr, password)
       server.sendmail(from_addr, [to_addr], msg.as_string())
       server.quit()
   
   
   if __name__ == "__main__":
       send_mail(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
   ```

   